<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<style>
  /* Warna Dasar Laut */
  :root {
    --primary-blue: #0077b6; /* Biru Laut Tua (Dominan) */
    --secondary-blue: #00b4d8; /* Biru Muda Segar */
    --background-light: #e0f7fa; /* Biru Muda Sangat Terang */
    --text-dark: #03045e; /* Biru Navy untuk Teks */
    --button-success: #48cae4; /* Biru Aquamarine untuk Register */
    --button-warning: #ffb703; /* Kuning Cerah untuk Switch/Aksen */
    --button-danger: #ef476f; /* Merah Coral untuk Logout/Delete */
    --shadow-color: rgba(0, 119, 182, 0.2);
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--background-light); /* Latar Belakang Biru Muda Sangat Terang */
    display: flex;
    justify-content: center;
    align-items: flex-start; /* Pusatkan ke atas */
    min-height: 100vh;
    padding: 40px 20px;
  }

  .container {
    background: rgb(255, 255, 255);
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 10px 30px var(--shadow-color); /* Bayangan dengan nuansa biru */
    width: 100%;
    max-width: 1000px;
    border: 1px solid #b3e5fc; /* Border tipis biru muda */
  }

  h1, h2, h3 { 
    color: var(--text-dark); /* Teks Biru Navy */
    border-bottom: 2px solid var(--secondary-blue);
    padding-bottom: 10px;
    margin-top: 20px;
  }
  
  h1 { text-align: center; }

  input { 
    padding: 12px; 
    margin: 8px 0; 
    width: 100%; 
    border-radius: 8px; 
    border: 1px solid #b3e5fc; 
    font-size: 16px; 
    box-sizing: border-box; /* Penting agar padding tidak melebarkan input */
    transition: border-color 0.3s;
  }
  input:focus {
    border-color: var(--secondary-blue);
    outline: none;
    box-shadow: 0 0 5px rgba(0, 180, 216, 0.5);
  }

  button { 
    padding: 12px 25px; 
    margin: 10px 5px 15px 0; 
    border: none; 
    border-radius: 25px; /* Tombol membulat */
    cursor: pointer; 
    color: white; 
    font-size: 16px;
    font-weight: bold;
    transition: background-color 0.3s, transform 0.2s;
  }

  /* Warna Tombol */
  .btn-login { background: var(--primary-blue); } 
  .btn-register { background: var(--button-success); } 
  .btn-logout { background: var(--button-danger); }
  .btn-switch { background: var(--button-warning); }
  /* Warna tombol di dalam tabel */
  td button {
    background: var(--button-danger);
    padding: 8px 15px;
    border-radius: 5px;
    font-size: 14px;
    margin: 0;
  }

  button:hover { 
    opacity: 1; 
    filter: brightness(1.1);
    transform: translateY(-1px);
  }

  .msg { font-weight: bold; margin: 15px 0; padding: 10px; border-radius: 5px; }
  .green { color: var(--text-dark); background: #ccffcc; border: 1px solid #a3c4a3; }
  .red { color: #8a0304; background: #ffcccc; border: 1px solid #c4a3a3; }

  /* Styling Tabel */
  table { 
    width: 100%; 
    border-collapse: separate; 
    border-spacing: 0;
    margin: 20px 0; 
    border-radius: 10px;
    overflow: hidden; 
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
  }
  
  th { 
    background-color: var(--secondary-blue); 
    color: white; 
    padding: 15px 8px; 
    text-align: left;
  }
  td { 
    padding: 12px 8px; 
    text-align: left;
    border-bottom: 1px solid #f0f0f0; 
  }
  
  /* Garis horizontal dan warna baris */
  tr:nth-child(even) { background-color: #f8f8f8; } 
  tr:hover { background-color: #e6f7ff; } 
  
  /* Menghilangkan border pada tabel */
  table, th, td { border: none; }
  
  /* Kolom status */
  .status-on { color: var(--button-success); font-weight: bold; }
  .status-off { color: var(--button-danger); font-weight: bold; }

  .hidden { display:none; }

  /* *** PERUBAHAN UTAMA: Mengecilkan dan memusatkan form Login/Register *** */
  #loginDiv, #registerDiv {
      padding: 20px;
      border: 1px solid #b3e5fc;
      border-radius: 10px;
      max-width: 400px; /* Lebar Maksimum yang Lebih Kecil */
      margin: 20px auto; /* Memastikan Form berada di tengah */
  }
  
  #dashboardDiv h3 {
      margin-top: 30px;
      color: var(--primary-blue);
  }
</style>
</head>
<body>
<div class="container">

  <div id="loginDiv">
    <h1>Login Admin</h1>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Password">
    <button id="loginBtn" class="btn-login">Login</button>
    <button id="goRegisterBtn" class="btn-switch">Register</button>
    <div id="loginMsg" class="msg"></div>
  </div>

  <div id="registerDiv" class="hidden">
    <h1>Register New Admin</h1>
    <input type="email" id="regEmail" placeholder="Email">
    <input type="password" id="regPassword" placeholder="Password">
    <button id="regBtn" class="btn-register">Register</button>
    <button id="backLoginBtn" class="btn-switch">Back to Login</button>
    <div id="regMsg" class="msg"></div>
  </div>

  <div id="dashboardDiv" class="hidden">
    <h2>ðŸŒŠ Selamat Datang di Admin Dashboard</h2>
    <button id="logoutBtn" class="btn-logout">Logout</button>

    <h3>Data Pengguna</h3>
    <table>
      <thead>
        <tr><th>ID</th><th>Firstname</th><th>Lastname</th><th>Email</th><th>Action</th></tr>
      </thead>
      <tbody id="userTable"></tbody>
    </table>

    <h3>API Keys Aktif</h3>
    <table>
      <thead>
        <tr><th>ID</th><th>Key</th><th>User ID</th><th>Status</th><th>Out of Date</th><th>Action</th></tr>
      </thead>
      <tbody id="keyTable"></tbody>
    </table>
  </div>

</div>

<script>
let token = null;

// Switch divs
const loginDiv = document.getElementById("loginDiv");
const registerDiv = document.getElementById("registerDiv");
const dashboardDiv = document.getElementById("dashboardDiv");

document.getElementById("goRegisterBtn").onclick = () => {
  loginDiv.classList.add("hidden");
  registerDiv.classList.remove("hidden");
};
document.getElementById("backLoginBtn").onclick = () => {
  registerDiv.classList.add("hidden");
  loginDiv.classList.remove("hidden");
};

// REGISTER
document.getElementById("regBtn").onclick = async () => {
  const email = document.getElementById("regEmail").value;
  const password = document.getElementById("regPassword").value;
  const res = await fetch("/api/admin/register", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({email,password})
  });
  const data = await res.json();
  const msg = document.getElementById("regMsg");
  msg.innerText = data.message;
  msg.className = data.token ? "msg green" : "msg red"; 
};

// LOGIN
document.getElementById("loginBtn").onclick = async () => {
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  const res = await fetch("/api/admin/login", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({email,password})
  });
  const data = await res.json();
  const msg = document.getElementById("loginMsg");

  if(data.token){
    token = data.token;
    loginDiv.classList.add("hidden");
    dashboardDiv.classList.remove("hidden");
    msg.innerText = "";
    loadUsers();
    loadKeys();
  } else {
    msg.innerText = data.message;
    msg.className = "msg red"; 
  }
};

// LOGOUT
document.getElementById("logoutBtn").onclick = () => {
  token = null;
  dashboardDiv.classList.add("hidden");
  loginDiv.classList.remove("hidden");
  document.getElementById("userTable").innerHTML="";
  document.getElementById("keyTable").innerHTML="";
  alert("Logout berhasil");
};

// LOAD USERS
async function loadUsers(){
  const res = await fetch("/api/apikey/all",{ headers:{Authorization:`Bearer ${token}`} });
  const data = await res.json();
  const tbody = document.getElementById("userTable");
  tbody.innerHTML="";
  data.forEach(u=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${u.id}</td><td>${u.firstname}</td><td>${u.lastname}</td><td>${u.email}</td>
      <td><button onclick="deleteUser(${u.id})">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

// LOAD KEYS
async function loadKeys(){
  const res = await fetch("/api/apikey/keys",{ headers:{Authorization:`Bearer ${token}`} });
  const data = await res.json();
  const tbody=document.getElementById("keyTable");
  tbody.innerHTML="";
  const now = new Date();
  data.forEach(k=>{
    const isOutOfDate = new Date(k.out_of_date)<now;
    const statusText = isOutOfDate ? "expired":"active";
    const statusClass = isOutOfDate ? "status-off" : "status-on"; 
    
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${k.id}</td><td>${k.key}</td><td>${k.user_id}</td><td class="${statusClass}">${statusText}</td><td>${k.out_of_date}</td>
      <td><button onclick="deleteKey(${k.id})">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

// DELETE USER
async function deleteUser(id){
  await fetch(`/api/apikey/delete/${id}`,{method:"DELETE", headers:{Authorization:`Bearer ${token}`}});
  loadUsers();
  loadKeys();
}

// DELETE KEY
async function deleteKey(id){
  await fetch(`/api/apikey/key/${id}`,{method:"DELETE", headers:{Authorization:`Bearer ${token}`}});
  loadKeys();
}
</script>
</body>
</html>